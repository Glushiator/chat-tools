<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Geo-Timestamp</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/buefy/dist/buefy.min.css">
  <style>
    body { padding: 1rem; }
    #app { max-width: 600px; margin: auto; }
    pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <div id="app">
    <section>
      <b-field label="Dark mode" horizontal>
        <b-switch v-model="darkMode"></b-switch>
      </b-field>
    </section>

    <section class="box">
      <b-button type="is-primary" @click="copyInfo" expanded>Copy Timestamp &amp; Location</b-button>
      <p class="mt-2" v-html="status"></p>
    </section>

    <section class="box">
      <h3 class="title is-5">Manage Saved Locations</h3>
      <b-field label="Label">
        <b-input v-model="label" placeholder="Enter label"></b-input>
      </b-field>
      <b-button type="is-success" @click="saveLocation" expanded class="mb-2">Save Current Location</b-button>
      <div class="buttons">
        <b-button type="is-link" @click="exportLocations">Export</b-button>
        <b-button type="is-warning" @click="triggerImport">Import</b-button>
        <input type="file" ref="importFile" @change="handleImport" accept="application/json" style="display:none">
      </div>
      <b-table :data="savedLocations" :key="savedLocations.length" :paginated="false"
               detailed>
        <template #default="props">
          <b-table-column field="label" label="Label" width="40%">
            {{ props.row.label }}
          </b-table-column>
          <b-table-column label="Lat">
            {{ props.row.coords.lat.toFixed(4) }}
          </b-table-column>
          <b-table-column label="Lon">
            {{ props.row.coords.lon.toFixed(4) }}
          </b-table-column>
        </template>
      </b-table>
      <p v-if="!savedLocations.length" class="has-text-centered">No locations saved yet.</p>
    </section>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/buefy/dist/buefy.min.js"></script>
  <script>
  const STORAGE_KEY = 'savedLocations'
  const { createApp } = Vue
  createApp({
    data() {
      return {
        label: '',
        savedLocations: [],
        darkMode: false,
        status: 'Click the button to copy info'
      }
    },
    mounted() {
      this.loadSaved()
      this.darkMode = localStorage.getItem('darkMode') === 'true'
      if (this.darkMode) document.documentElement.classList.add('has-background-dark')
    },
    watch: {
      darkMode(val) {
        localStorage.setItem('darkMode', val)
        document.documentElement.classList.toggle('has-background-dark', val)
      }
    },
    methods: {
      loadSaved() {
        this.savedLocations = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []
      },
      saveToStore() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.savedLocations))
      },
      calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3
        const toRad = x => x * Math.PI / 180
        const dPhi = toRad(lat2 - lat1)
        const dLam = toRad(lon2 - lon1)
        const a = Math.sin(dPhi/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLam/2)**2
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))
        return R * c
      },
      async getAddress(lat, lon) {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
          const data = await res.json()
          return data.display_name || 'Address not found'
        } catch (e) {
          return 'Address lookup failed'
        }
      },
      async copyInfo() {
        this.status = 'Getting location...'
        navigator.geolocation.getCurrentPosition(async pos => {
          const {latitude, longitude} = pos.coords
          let locationString = ''
          let matchFound = false
          for (const loc of this.savedLocations) {
            const d = this.calculateDistance(latitude, longitude, loc.coords.lat, loc.coords.lon)
            if (d <= 100) {
              locationString = `at ${loc.label}`
              matchFound = true
              break
            }
          }
          if (!matchFound) {
            this.status = 'No saved match. Looking up address...'
            const addr = await this.getAddress(latitude, longitude)
            locationString = `at ${addr}`
          }
          const timestamp = new Date().toLocaleString('en-US', {
            weekday: 'short', month: 'short', day: 'numeric', year: 'numeric',
            hour: 'numeric', minute: '2-digit', hour12: true
          })
          const finalStr = `[${timestamp} ${locationString}]`
          this.status = `Ready: <code>${finalStr}</code>`
          try {
            await navigator.clipboard.writeText(finalStr)
            this.status += '<br>Copied!'
          } catch (e) {
            this.status += '<br>Clipboard error.'
          }
        }, () => {
          this.status = 'Error: Could not get location.'
        })
      },
      saveLocation() {
        if (!this.label.trim()) return
        navigator.geolocation.getCurrentPosition(pos => {
          this.savedLocations.push({ label: this.label.trim(), coords: { lat: pos.coords.latitude, lon: pos.coords.longitude } })
          this.saveToStore()
          this.label = ''
          this.status = `Location "${this.savedLocations[this.savedLocations.length-1].label}" saved.`
        }, () => {
          this.status = 'Error: Could not get location to save it.'
        })
      },
      exportLocations() {
        const blob = new Blob([JSON.stringify(this.savedLocations, null, 2)], {type: 'application/json'})
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'locations.json'
        a.click()
        URL.revokeObjectURL(url)
      },
      triggerImport() {
        this.$refs.importFile.click()
      },
      handleImport(e) {
        const file = e.target.files[0]
        if (!file) return
        const reader = new FileReader()
        reader.onload = evt => {
          try {
            const imported = JSON.parse(evt.target.result)
            if (Array.isArray(imported)) {
              this.savedLocations = imported
              this.saveToStore()
              this.status = 'Locations imported!'
            } else {
              this.status = 'Import failed: Invalid format.'
            }
          } catch {
            this.status = 'Import failed: Not valid JSON.'
          }
        }
        reader.readAsText(file)
      }
    }
  }).use(Buefy).mount('#app')
  </script>
</body>
</html>
